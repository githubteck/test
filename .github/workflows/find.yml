name: run find_m3u8.py

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *'  # runs every hour
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Needed for API interactions if any

    env:
      REPO_OWNER: githubteck
      REPO_NAME: test
      FILE_PATH: mana2.m3u8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Create and run Python script
        run: |
          cat << 'EOF' > generate_m3u8.py
          import requests
          import base64
          import os
          import gzip

          REPO_OWNER = "${{ env.REPO_OWNER }}"
          REPO_NAME = "${{ env.REPO_NAME }}"
          FILE_PATH = "${{ env.FILE_PATH }}"
          GITHUB_TOKEN = "${{ secrets.ABC }}"

          headers = {
              "Authorization": f"token {GITHUB_TOKEN}",
              "Accept": "application/vnd.github.v3+json"
          }

          # Fetch the file content from GitHub API
          url = f"https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/contents/{FILE_PATH}"
          response = requests.get(url, headers=headers)

          if response.status_code == 200:
              content_json = response.json()
              encoded_content = content_json["content"]
              decoded_bytes = base64.b64decode(encoded_content)

              # Do something with the decoded content
              print(f"Content of {FILE_PATH} downloaded successfully.")
          else:
              print(f"Failed to fetch file: {response.status_code}")
          EOF

          python generate_m3u8.py
