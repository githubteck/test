name: run find_m3u8.py

on:
  push:
    branches:
      - main
  schedule:
    - cron: '0 * * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    env:
      REPO_OWNER: githubteck
      REPO_NAME: test
      FILE_PATH: mana2.m3u8

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install requests beautifulsoup4

      - name: Check if file exists and create if not
        run: |
          cat << 'EOF' > generate_m3u8.py
          import requests
          import base64
          import json

          REPO_OWNER = "${{ env.REPO_OWNER }}"
          REPO_NAME = "${{ env.REPO_NAME }}"
          FILE_PATH = "${{ env.FILE_PATH }}"
          GITHUB_TOKEN = "${{ secrets.ABC }}"

          headers = {
              "Authorization": f"token {GITHUB_TOKEN}",
              "Accept": "application/vnd.github.v3+json"
          }

          # API URL to get file content
          url = f"https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/contents/{FILE_PATH}"

          response = requests.get(url, headers=headers)

          if response.status_code == 200:
              print(f"{FILE_PATH} exists. Fetching content.")
              content_json = response.json()
              encoded_content = content_json["content"]
              decoded_bytes = base64.b64decode(encoded_content)
              print(f"Content of {FILE_PATH} downloaded successfully.")

          elif response.status_code == 404:
              print(f"{FILE_PATH} does not exist. Creating it.")

              initial_content = "# New m3u8 playlist\n# Add your content here"
              encoded_content = base64.b64encode(initial_content.encode()).decode()

              create_url = f"https://api.github.com/repos/{REPO_OWNER}/{REPO_NAME}/contents/{FILE_PATH}"
              data = {
                  "message": "Create mana2.m3u8 file",
                  "content": encoded_content
              }

              create_response = requests.put(
                  create_url,
                  headers=headers,
                  data=json.dumps(data)
              )

              if create_response.status_code == 201:
                  print(f"{FILE_PATH} created successfully.")
              else:
                  print(f"Failed to create file: {create_response.status_code}")
                  print(create_response.text)

          else:
              print(f"Error fetching file: {response.status_code}")
          EOF

          python generate_m3u8.py
