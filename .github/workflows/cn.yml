name: Generate M3U8 Playlist and Create File

on:
  push:
    branches:
      - main # Change this to your default branch name if it's not 'main'
  schedule:
    - cron: '0 0 * * *' # Runs daily at midnight UTC
  workflow_dispatch: # Allows manual triggering from the GitHub UI

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write # Needed for the API call to write to the repository

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests beautifulsoup4 jq # jq is still useful for payload creation

    - name: Run script and generate cn.m3u8
      run: |
        python cn.py > cn.m3u8 # Assuming your script prints the M3U8 to stdout

    - name: Check if cn.m3u8 was created
      run: |
        if [ ! -f cn.m3u8 ]; then
          echo "Error: cn.m3u8 file was not created by cn.py"
          exit 1
        fi

    - name: Create cn.m3u8 via GitHub API
      run: |
        FILE_CONTENT_BASE64=$(base64 -w 0 cn.m3u8) # Base64 encode the file content
        COMMIT_MESSAGE="Create cn.m3u8"
        API_URL="https://api.github.com/repos/githubteck/test/contents/cn.m3u8"

        PAYLOAD='{
          "message": "'"$COMMIT_MESSAGE"'",
          "content": "'"$FILE_CONTENT_BASE64"'"
        }'

        # Use jq to format the payload correctly before sending (optional but good practice)
        PAYLOAD=$(echo "$PAYLOAD" | jq tostring -c)

        curl -X PUT "$API_URL" \
          -H "Authorization: token ${{ secrets.ABC }}" \
          -H "Content-Type: application/json" \
          -d "$PAYLOAD
